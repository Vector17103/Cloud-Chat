<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Chat - General Room</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button class="theme-toggle" id="themeToggle">
    <span class="theme-toggle-icon" id="themeIcon">‚òÄ</span>
    <span id="themeText">Light</span>
  </button>
  <div class="container">
    <div class="page-header">
      <h1>Cloud Chat</h1>
      <p class="text-muted">General Room</p>
    </div>

    <div id="chatArea" style="display:none;">
      <!-- Chat Messages -->
      <div id="chat"></div>

      <!-- Message Input -->
      <div class="message-input-container">
        <textarea id="message" placeholder="Type your message... (Shift+Enter for new line)" rows="2"></textarea>
        <button class="emoji-picker-btn" id="emojiBtn">üòä</button>
        <button id="send">Send</button>
        <div class="emoji-picker" id="emojiPicker">
          <div class="emoji-grid" id="emojiGrid"></div>
        </div>
      </div>

      <!-- Main Controls -->
      <div class="controls">
        <button id="logout" class="btn-secondary">Logout</button>
      </div>

      <!-- Admin Controls -->
      <div id="adminControls" style="display:none;">
        <h4>‚öôÔ∏è Admin Controls</h4>
        <div class="controls">
          <button id="deleteAll" class="btn-danger">Delete All Messages</button>
          <button id="goToAdmin">Chatroom Manager</button>
        </div>
      </div>

      <!-- Private Rooms List -->
      <div id="myRooms">
        <h3>Private Chatrooms</h3>
        <div id="roomsList">
          <p class="loading">Loading your rooms...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7lofjQ5AIFT6n-e1LpyployJxGdBChPE",
      authDomain: "cosc-3657.firebaseapp.com",
      databaseURL: "https://cosc-3657-default-rtdb.firebaseio.com",
      projectId: "cosc-3657",
      storageBucket: "cosc-3657.appspot.com",
      messagingSenderId: "899690413890",
      appId: "1:899690413890:web:2381f893e86abf3bc412db",
      measurementId: "G-JJC34GHJZL"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const chatRef = ref(db, "chatrooms/general/messages");

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("chatArea").style.display = "block";
        const username = (user.displayName || user.email).toLowerCase();

        // Check user role
        get(ref(db, "roles/" + username)).then(roleSnap => {
          const role = roleSnap.exists() ? roleSnap.val() : "user";
          window.currentRole = role;

          console.log("User role:", role);

          // Show admin controls if user is admin
          if (role === "admin") {
            document.getElementById("adminControls").style.display = "block";

            // Admin button to navigate to admin page
            document.getElementById("goToAdmin").onclick = () => {
              window.location.href = "admin.html";
            };

            // Delete all messages button
            document.getElementById("deleteAll").onclick = () => {
              if (confirm("Are you sure you want to delete all messages?")) {
                remove(chatRef).then(() => {
                  alert("All messages deleted by admin");
                  document.getElementById("chat").innerHTML = "";
                }).catch(error => {
                  alert("Error deleting messages: " + error.message);
                });
              }
            };

            // Admins can see all rooms
            loadAllRooms(username);
          } else {
            // Regular users see only their rooms
            loadUserRooms(username);
          }

          // Listen for new messages
          onChildAdded(chatRef, snapshot => {
            const chatDiv = document.getElementById("chat");
            const msgData = snapshot.val();
            const msgId = snapshot.key;

            const msgElement = document.createElement("div");
            msgElement.className = "msg";
            msgElement.id = "msg-" + msgId;

            const msgContent = document.createElement("div");
            msgContent.className = "msg-content";
            msgContent.textContent = msgData.user + ": " + msgData.text;
            
            // NEW: Show edited indicator
            if (msgData.edited) {
              const editedSpan = document.createElement("span");
              editedSpan.className = "msg-edited-indicator";
              editedSpan.textContent = "(edited)";
              msgContent.appendChild(editedSpan);
            }
            
            msgElement.appendChild(msgContent);

            // NEW: Message actions
            const msgActions = document.createElement("div");
            msgActions.className = "msg-actions";

            // Edit button for own messages
            if (msgData.user === username) {
              const editBtn = document.createElement("button");
              editBtn.className = "btn-small btn-edit";
              editBtn.textContent = "Edit";
              editBtn.onclick = () => editMessage(msgId, msgData.text, msgData.user);
              msgActions.appendChild(editBtn);
            }

            // Delete button for admins
            if (window.currentRole === "admin") {
              const delBtn = document.createElement("button");
              delBtn.className = "btn-small btn-danger";
              delBtn.textContent = "Delete";
              delBtn.onclick = () => {
                remove(ref(db, "chatrooms/general/messages/" + msgId)).then(() => {
                  const element = document.getElementById("msg-" + msgId);
                  if (element) element.remove();
                }).catch(error => {
                  alert("Error deleting message: " + error.message);
                });
              };
              msgActions.appendChild(delBtn);
            }

            if (msgActions.children.length > 0) {
              msgElement.appendChild(msgActions);
            }

            chatDiv.appendChild(msgElement);
            chatDiv.scrollTop = chatDiv.scrollHeight;
          });
        }).catch(error => {
          console.error("Error fetching role:", error);
          alert("Error checking user role: " + error.message);
        });

        // Send messages
        document.getElementById("send").onclick = () => {
          const msg = document.getElementById("message").value;
          if (msg.trim() !== "") {
            const newMsgRef = push(chatRef);
            set(newMsgRef, {
              user: username,
              text: msg,
              timestamp: Date.now()
            }).then(() => {
              document.getElementById("message").value = "";
            }).catch(error => {
              alert("Error sending message: " + error.message);
            });
          }
        };

        // NEW: Handle Enter key (send) and Shift+Enter (new line)
        const messageTextarea = document.getElementById("message");
        messageTextarea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById("send").click();
          }
        });

        // Logout
        document.getElementById("logout").onclick = () => {
          signOut(auth).then(() => {
            window.location.href = "login.html";
          });
        };

        // NEW FEATURE: Emoji picker functionality
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');

        // Common emojis
        const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üëç','üëé','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','‚úã','ü§ö','üñê','üññ','üëã','ü§ù','üí™','üôè','‚ù§Ô∏è','üíï','üíñ','üíó','üíô','üíö','üíõ','üß°','üíú','üñ§','üíî','‚ù£Ô∏è','üíû','üíù','üíò','üíó','‚ú®','‚≠ê','üåü','üí´','‚ö°','üî•','üí•','üíØ','üéâ','üéä','üéà','üéÅ','üèÜ','ü•á','ü•à','ü•â'];

        // Populate emoji grid
        emojis.forEach(emoji => {
          const emojiItem = document.createElement('span');
          emojiItem.className = 'emoji-item';
          emojiItem.textContent = emoji;
          emojiItem.onclick = () => insertEmoji(emoji);
          emojiGrid.appendChild(emojiItem);
        });

        // Toggle emoji picker
        emojiBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          emojiPicker.classList.toggle('show');
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
          if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.classList.remove('show');
          }
        });

        // Insert emoji at cursor position
        function insertEmoji(emoji) {
          const start = messageTextarea.selectionStart;
          const end = messageTextarea.selectionEnd;
          const text = messageTextarea.value;
          messageTextarea.value = text.substring(0, start) + emoji + text.substring(end);
          messageTextarea.selectionStart = messageTextarea.selectionEnd = start + emoji.length;
          messageTextarea.focus();
          emojiPicker.classList.remove('show');
        }

        // NEW FEATURE: Edit message function
        function editMessage(msgId, currentText, msgUser) {
          const msgElement = document.getElementById("msg-" + msgId);
          if (!msgElement) return;

          const originalContent = msgElement.innerHTML;
          msgElement.innerHTML = '';
          msgElement.classList.add('editing');

          const editTextarea = document.createElement("textarea");
          editTextarea.className = "msg-edit-input";
          editTextarea.value = currentText;
          editTextarea.rows = 3;
          msgElement.appendChild(editTextarea);

          const editActions = document.createElement("div");
          editActions.className = "msg-edit-actions";

          const saveBtn = document.createElement("button");
          saveBtn.className = "btn-small";
          saveBtn.textContent = "Save";
          saveBtn.onclick = () => {
            const newText = editTextarea.value.trim();
            if (newText && newText !== currentText) {
              set(ref(db, "chatrooms/general/messages/" + msgId), {
                user: msgUser,
                text: newText,
                timestamp: Date.now(),
                edited: true,
                editedAt: Date.now()
              }).then(() => {
                location.reload();
              }).catch(error => {
                alert("Error updating message: " + error.message);
                msgElement.innerHTML = originalContent;
              });
            } else {
              msgElement.innerHTML = originalContent;
              msgElement.classList.remove('editing');
            }
          };

          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn-small btn-secondary";
          cancelBtn.textContent = "Cancel";
          cancelBtn.onclick = () => {
            msgElement.innerHTML = originalContent;
            msgElement.classList.remove('editing');
          };

          editActions.appendChild(saveBtn);
          editActions.appendChild(cancelBtn);
          msgElement.appendChild(editActions);
          editTextarea.focus();
        }
      } else {
        window.location.href = "login.html";
      }
    });

    // Load all rooms for admins
    function loadAllRooms(username) {
      const roomsListDiv = document.getElementById("roomsList");
      
      get(ref(db, "chatrooms")).then(snapshot => {
        if (snapshot.exists()) {
          const rooms = snapshot.val();
          let privateRoomCount = 0;
          roomsListDiv.innerHTML = "";

          Object.keys(rooms).forEach(roomName => {
            if (roomName !== "general") {
              const roomLink = document.createElement("div");
              roomLink.className = "room-link";
              roomLink.textContent = " ‚ùá " + roomName;
              roomLink.onclick = () => {
                window.location.href = "chatroom.html?room=" + roomName;
              };
              roomsListDiv.appendChild(roomLink);
              privateRoomCount++;
            }
          });

          if (privateRoomCount === 0) {
            roomsListDiv.innerHTML = '<p class="no-content">No private rooms yet.</p>';
          }
        } else {
          roomsListDiv.innerHTML = '<p class="no-content">No private rooms yet.</p>';
        }
      }).catch(error => {
        console.error("Error loading rooms:", error);
        roomsListDiv.innerHTML = '<p class="no-content">Error loading rooms.</p>';
      });
    }

    // Load user's rooms by checking membership
    function loadUserRooms(username) {
      const roomsListDiv = document.getElementById("roomsList");
      roomsListDiv.innerHTML = '<p class="loading">Checking your rooms...</p>';
      
      get(ref(db, "userMemberships/" + username)).then(snapshot => {
        if (snapshot.exists()) {
          const memberRooms = snapshot.val();
          roomsListDiv.innerHTML = "";
          let roomCount = 0;

          Object.keys(memberRooms).forEach(roomName => {
            if (memberRooms[roomName] === true) {
              const roomLink = document.createElement("div");
              roomLink.className = "room-link";
              roomLink.textContent = " ‚ùá " + roomName;
              roomLink.onclick = () => {
                window.location.href = "chatroom.html?room=" + roomName;
              };
              roomsListDiv.appendChild(roomLink);
              roomCount++;
            }
          });

          if (roomCount === 0) {
            roomsListDiv.innerHTML = '<p class="no-content">You are not a member of any private rooms yet.</p>';
          }
        } else {
          roomsListDiv.innerHTML = '<p class="no-content">You are not a member of any private rooms yet.</p>';
        }
      }).catch(error => {
        console.error("Error loading user rooms:", error);
        roomsListDiv.innerHTML = '<p class="no-content">Error loading your rooms.</p>';
      });
    }
  </script>
  <script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  const htmlElement = document.documentElement;

  const currentTheme = localStorage.getItem('theme') || 'dark';
  htmlElement.setAttribute('data-theme', currentTheme);
  updateThemeUI(currentTheme);

  themeToggle.addEventListener('click', () => {
    const newTheme = htmlElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    htmlElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeUI(newTheme);
  });

  function updateThemeUI(theme) {
    if (theme === 'light') {
      themeIcon.textContent = '‚òæ';
      themeText.textContent = 'Dark';
    } else {
      themeIcon.textContent = '‚òÄ';
      themeText.textContent = 'Light';
    }
  }
</script>
</body>
</html>